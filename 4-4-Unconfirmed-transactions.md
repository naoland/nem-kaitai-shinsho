（おしらせ）

4.3のマルチシグについては、自分で使っていなくて理解が追いついてこないので、ちょっと飛ばします。
講義ノート的に書いていますから、公開後、より読みやすくするために随時改訂しています。特に公開２４時間以内に、かなり手を入れていますので、一つ前のやつを読んでもらうと、昨日より読みやすくなっているかもしれません。
なんとか最後までたどりついたら、一冊のPDFファイルにまとめてアポスティーユ使ってネムストアで格安で売ろうかとか、訳解んないことを考え始めました。

では妄想はこのくらいにして、続けます（僕が付けたコメントは赤で表示されています）。

----

# 4.4 未承認トランザクション（スパムフィルター）

新しいトランザクションが作られて、ノードのひとつに届けられた時、ノードは以下の２つのことをします。


1. トランザクションを未承認トランザクションキャッシュに入れる。
2. トランザクションを他のノードにブロードキャストする（トランザクション内容が合格のときだけ）。

ブロックチェーンの同期ごとに、未承認トランザクションのpollも行われます。これは、ポート7890が開いていない（そのためブロードキャストを受け取れない＝UDPポートがあいていない？）ノードにも未承認トランザクションが届くようにするためです。

トランザクション手数料が安価に設定されているため、悪意のあるユーザーが大量の新規トランザクションを送り込んでネットワークの運用を妨害するかもしれません。そのために、未承認トランザクションの最大数を定める必要があります。


１番単純なのは、１つのノードが受け取れる未承認トランザクションに最大数を定めてしまうことですが、これだと一般ユーザーのトランザクションにも影響が出てしまいます。攻撃を受けている間も、正当なトランザクションは受け取れるようにしておかなければなりません。また、トランザクションを送付するアカウント側に、送出できる未承認トランザクションの最大数を定めるのもよくありません。なぜならアカウントはいくらでも増やせるから、大量のアカウントを作って送り込めば良いからです。


そのため、NEMは特別なフィルター（スパムフィルター）機能を持っています。スパムフィルターが、新しい未承認トランザクションを、受け付けるか拒否するかを決定する仕組みを以下に示します。

まず未承認トランザクションを入れる1000個のスロットを用意します。

120スロットまでは、すべて受け入れます。

それ以上の数（fs個）のスロットが埋まった状態で受け取った未承認トランザクションが、アカウント（原文ではsignerとなってます）Aから届いたとします。その際アカウントAは以下の計算で求めた有効スロット数（fair share）分のスロットを使用できる事にします。

以下の式によって有効スロット数を求めることができます。

アカウントAが有効スロット数未満の数のスロットを使う場合のみ、新しい未承認トランザクションを受け付けます。

![](https://s3-ap-northeast-1.amazonaws.com/nem-social/blog/0/8000/8400/8473/1544058572%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202018-12-06%2010.09.18.png)

トランザクション手数料を増やして、その合計が1000（単位はXEM？）を超えると、より多くのスロットを使うことができるようになります。


図3に、すでに埋まったスロットの数に対して、有効インポータンス（eff. importance）0.0001の場合のfair shareスロット数をグラフで示します。攻撃者が大量のスパムアカウントを作ってトランザクションを送り込んだ場合でも、それぞれのアカウントが持つインポータンスが低いならば、大きな影響を与えることはできないでしょう。トランザクション手数料を大きくして影響力を上げることもできますが、その分を攻撃者が負担することになります。

![](https://s3-ap-northeast-1.amazonaws.com/nem-social/blog/0/8000/8400/8473/1544059071%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202018-12-06%2010.17.35.png)  
図３ 有効インポータンスが0.0001 の場合の有効スロット数のグラフ（縦軸）

上の式のmax()の中が少しおかしい気がしますが、とりあえず攻撃者のアカウントのeff. インポータンスが0.001で、１トランザクションあたりの手数料を1000XEMにした場合（かなり本気）のfair shareスロット数も計算してみました。参考のためその場合のグラフを示します。この場合は、グラフが交差する300スロットくらいまで埋められそうです。

![](https://s3-ap-northeast-1.amazonaws.com/nem-social/blog/0/8000/8400/8473/1544064050%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202018-12-06%2011.39.28.png)

----

インポータンスを使う場面がようやく出てきました。NEMのネットワークを麻痺させるくらいの大量のトランザクションを生じさせるには、高いインポータンスが必要な上、莫大な手数料もかかるようになっているのですね。


