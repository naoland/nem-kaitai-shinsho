# 4.1 XEM送付トランザクション

送付（トランスファー）トランザクションは、XEMをひとつのアカウントから別のアカウントに送付する時に使われます。

最大1024バイトのメッセージも添付できます。

暗号化されたメッセージの場合、960バイト（976バイトじゃないのか？）までになります。

なぜなら塩とIVデータが付加されるからです。


塩（salt）とIVってなんじゃらほい？ここで読み飛ばしてしまった「3.3 メッセージの暗号化」を読んでみます。
メッセージの暗号化はAESの共通鍵方式を利用します（そういう暗号化エンジンが存在し、世界で広く使われているらしい）。

アリスの秘密鍵とボブの公開鍵を利用して暗号化をする場合、適当な32バイトの塩コードを用意して、秘密鍵と公開鍵と塩を組み合わせたもののハッシュを取り、共有鍵とします。

その他に16バイトのランダムなIV（Inistializing Vectorの略）というものを用意。塩（32バイト）、IV（16バイト）、暗号化したメッセージを一緒に送ります。

受け取ったボブは自分の秘密鍵とアリスの公開鍵と塩を使って、共有鍵を再現できるので、IVと暗号化メッセージをAESのエンジンに送って解読します。


【解説】書くとものすごくややこしいですが、ポイントになるのは、アリスの秘密鍵とボブの公開鍵を掛け算して得られる数値が、アリスの公開鍵とボブの秘密鍵をかけ合わせたものと等しくなるというところ。楕円関数の重要な性質です。
a(alice)をアリスの秘密鍵、a(bob)をボブの秘密鍵、A(alice)をアリスの公開鍵、A(bob)をボブの公開鍵としします。

```
A(alice) = a(alice) B
A(bob) = a(bob) B
```

Bは暗号化の章で説明した、楕円関数上のある点のことを示します。

```
アリスが計算する共有鍵 = a(alice) A(bob) = a(alice) a(bob) B
ボブが計算する共有鍵 = a(bob) A(alice) = a(bob) a(alice) B
```

秘密鍵は、楕円関数に沿って何回移動を繰り返すかを規定していますから、a(alice) a(bob)とa(bob) a(alice)が等しくなります。つまり、どちらも同じ回数だけBを移動させるから、同じ点に行き着きます。その結果アリスとボブが持つ共有鍵が等しくなるわけです。でもいつも同じ回数だけ動かしていると、他の人に暗号を解かれてしまうので、塩で動かす回数を毎回変えて、解読リスクを下げているわけですね。これがわかった時、僕は初めてこの暗号システムの原理が分かった気がしました。

送付トランザクションにかかる手数料は２つのパートに分かれます。

- 10000XEMあたり0.05XEM（最大で1.25XEM、つまり25万XEM以上は定額で1.25XEM）。
- メッセージが32バイト増えるごとに0.05XEM。

この両方を足し合わせたものが手数料になります。

